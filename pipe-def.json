{
      "Version": "2020-12-01",
      "Metadata": {},
      "Parameters": [
            {
                  "Name": "ProcessingInstanceType",
                  "Type": "String",
                  "DefaultValue": "ml.m5.xlarge"
            },
            {
                  "Name": "ProcessingInstanceCount",
                  "Type": "Integer",
                  "DefaultValue": 1
            },
            {
                  "Name": "TrainingInstanceType",
                  "Type": "String",
                  "DefaultValue": "ml.m5.xlarge"
            },
            {
                  "Name": "ModelApprovalStatus",
                  "Type": "String",
                  "DefaultValue": "PendingManualApproval"
            },
            {
                  "Name": "InputDataUrl",
                  "Type": "String",
                  "DefaultValue": "s3://sagemaker-grewaltempl/data/finance/combined_tweets.csvv"
            }
      ],
      "PipelineExperimentConfig": {
            "ExperimentName": {
                  "Get": "Execution.PipelineName"
            },
            "TrialName": {
                  "Get": "Execution.PipelineExecutionId"
            }
      },
      "Steps": [
            {
                  "Name": "PreProcTweetsModelPipe",
                  "Type": "Processing",
                  "Arguments": {
                        "ProcessingResources": {
                              "ClusterConfig": {
                                    "InstanceType": {
                                          "Get": "Parameters.ProcessingInstanceType"
                                    },
                                    "InstanceCount": {
                                          "Get": "Parameters.ProcessingInstanceCount"
                                    },
                                    "VolumeSizeInGB": 30
                              }
                        },
                        "AppSpecification": {
                              "ImageUri": "683313688378.dkr.ecr.us-east-1.amazonaws.com/sagemaker-scikit-learn:0.23-1-cpu-py3",
                              "ContainerArguments": [
                                    "--input-data",
                                    "s3://sagemaker-grewaltempl/data/finance/combined_tweets.csv",
                                    "--data-size",
                                    "10000"
                              ],
                              "ContainerEntrypoint": [
                                    "python3",
                                    "/opt/ml/processing/input/code/preprocess_tweets.py"
                              ]
                        },
                        "RoleArn": "arn:aws:iam::034150676293:role/service-role/AmazonSageMaker-ExecutionRole-20220322T185187",
                        "ProcessingInputs": [
                              {
                                    "InputName": "input-1",
                                    "AppManaged": false,
                                    "S3Input": {
                                          "S3Uri": "s3://sagemaker-grewaltempl/data/finance/combined_tweets.csv",
                                          "LocalPath": "/opt/ml/processing/input",
                                          "S3DataType": "S3Prefix",
                                          "S3InputMode": "File",
                                          "S3DataDistributionType": "FullyReplicated",
                                          "S3CompressionType": "None"
                                    }
                              },
                              {
                                    "InputName": "code",
                                    "AppManaged": false,
                                    "S3Input": {
                                          "S3Uri": "s3://sagemaker-grewaltempl/PreProcTweetsModelPipe-337f9e7b6f3102656892aae3b3ecfffa/input/code/preprocess_tweets.py",
                                          "LocalPath": "/opt/ml/processing/input/code",
                                          "S3DataType": "S3Prefix",
                                          "S3InputMode": "File",
                                          "S3DataDistributionType": "FullyReplicated",
                                          "S3CompressionType": "None"
                                    }
                              }
                        ],
                        "ProcessingOutputConfig": {
                              "Outputs": [
                                    {
                                          "OutputName": "train",
                                          "AppManaged": false,
                                          "S3Output": {
                                                "S3Uri": "s3://sagemaker-grewaltempl/data/finance/curated/small/train",
                                                "LocalPath": "/opt/ml/processing/train",
                                                "S3UploadMode": "EndOfJob"
                                          }
                                    },
                                    {
                                          "OutputName": "test",
                                          "AppManaged": false,
                                          "S3Output": {
                                                "S3Uri": "s3://sagemaker-grewaltempl/data/finance/curated/small/test",
                                                "LocalPath": "/opt/ml/processing/test",
                                                "S3UploadMode": "EndOfJob"
                                          }
                                    },
                                    {
                                          "OutputName": "validation",
                                          "AppManaged": false,
                                          "S3Output": {
                                                "S3Uri": "s3://sagemaker-grewaltempl/data/finance/curated/small/validation",
                                                "LocalPath": "/opt/ml/processing/val",
                                                "S3UploadMode": "EndOfJob"
                                          }
                                    },
                                    {
                                          "OutputName": "evaluation-property-pass",
                                          "AppManaged": false,
                                          "S3Output": {
                                                "S3Uri": "s3://sagemaker-grewaltempl/data/finance/curated/small/evalproperty",
                                                "LocalPath": "/opt/ml/processing/evalproperty",
                                                "S3UploadMode": "EndOfJob"
                                          }
                                    }
                              ]
                        }
                  },
                  "CacheConfig": {
                        "Enabled": true,
                        "ExpireAfter": "1d"
                  },
                  "PropertyFiles": [
                        {
                              "PropertyFileName": "EvaluationReportPreproc",
                              "OutputName": "evaluation-property-pass",
                              "FilePath": "evaluation.json"
                        }
                  ]
            },
            {
                  "Name": "TrainTweetsStep",
                  "Type": "Training",
                  "Arguments": {
                        "AlgorithmSpecification": {
                              "TrainingInputMode": "File",
                              "TrainingImage": "683313688378.dkr.ecr.us-east-1.amazonaws.com/sagemaker-xgboost:1.3-1"
                        },
                        "OutputDataConfig": {
                              "S3OutputPath": "s3://sagemaker-grewaltempl/pipeline/model/xgbtrain/modeltweet"
                        },
                        "StoppingCondition": {
                              "MaxRuntimeInSeconds": 3600,
                              "MaxWaitTimeInSeconds": 7200
                        },
                        "ResourceConfig": {
                              "InstanceCount": 1,
                              "InstanceType": "ml.m5.large",
                              "VolumeSizeInGB": 30
                        },
                        "RoleArn": "arn:aws:iam::034150676293:role/service-role/AmazonSageMaker-ExecutionRole-20220322T185187",
                        "InputDataConfig": [
                              {
                                    "DataSource": {
                                          "S3DataSource": {
                                                "S3DataType": "S3Prefix",
                                                "S3Uri": {
                                                      "Get": "Steps.PreProcTweetsModelPipe.ProcessingOutputConfig.Outputs['train'].S3Output.S3Uri"
                                                },
                                                "S3DataDistributionType": "FullyReplicated"
                                          }
                                    },
                                    "ContentType": "text/csv",
                                    "ChannelName": "train"
                              },
                              {
                                    "DataSource": {
                                          "S3DataSource": {
                                                "S3DataType": "S3Prefix",
                                                "S3Uri": {
                                                      "Get": "Steps.PreProcTweetsModelPipe.ProcessingOutputConfig.Outputs['validation'].S3Output.S3Uri"
                                                },
                                                "S3DataDistributionType": "FullyReplicated"
                                          }
                                    },
                                    "ContentType": "text/csv",
                                    "ChannelName": "validation"
                              }
                        ],
                        "HyperParameters": {
                              "objective": "\"reg:linear\"",
                              "num_round": "50",
                              "max_depth": "5",
                              "eta": "0.2",
                              "gamma": "4",
                              "min_child_weight": "6",
                              "subsample": "0.7",
                              "silent": "0",
                              "sagemaker_submit_directory": "\"s3://sagemaker-grewaltempl/pipeline/model/xgbtrain/code/TrainTweetsModelPipe/tweets-pipeline-2022-04-14-19-46-12-820/source/sourcedir.tar.gz\"",
                              "sagemaker_program": "\"modeltrain.py\"",
                              "sagemaker_container_log_level": "20",
                              "sagemaker_region": "\"us-east-1\""
                        },
                        "EnableManagedSpotTraining": true,
                        "DebugHookConfig": {
                              "S3OutputPath": "s3://sagemaker-grewaltempl/pipeline/model/xgbtrain/modeltweet",
                              "CollectionConfigurations": []
                        },
                        "ProfilerRuleConfigurations": [
                              {
                                    "RuleConfigurationName": "ProfilerReport-1649965572",
                                    "RuleEvaluatorImage": "503895931360.dkr.ecr.us-east-1.amazonaws.com/sagemaker-debugger-rules:latest",
                                    "RuleParameters": {
                                          "rule_to_invoke": "ProfilerReport"
                                    }
                              }
                        ],
                        "ProfilerConfig": {
                              "S3OutputPath": "s3://sagemaker-grewaltempl/pipeline/model/xgbtrain/modeltweet"
                        }
                  },
                  "CacheConfig": {
                        "Enabled": true,
                        "ExpireAfter": "1d"
                  }
            },
            {
                  "Name": "EvaluateTweetsModelPipe",
                  "Type": "Processing",
                  "Arguments": {
                        "ProcessingResources": {
                              "ClusterConfig": {
                                    "InstanceType": {
                                          "Get": "Parameters.ProcessingInstanceType"
                                    },
                                    "InstanceCount": 1,
                                    "VolumeSizeInGB": 30
                              }
                        },
                        "AppSpecification": {
                              "ImageUri": "683313688378.dkr.ecr.us-east-1.amazonaws.com/sagemaker-xgboost:1.3-1",
                              "ContainerEntrypoint": [
                                    "/bin/bash",
                                    "/opt/ml/processing/input/entrypoint/runproc.sh"
                              ]
                        },
                        "RoleArn": "arn:aws:iam::034150676293:role/service-role/AmazonSageMaker-ExecutionRole-20220322T185187",
                        "ProcessingInputs": [
                              {
                                    "InputName": "input-1",
                                    "AppManaged": false,
                                    "S3Input": {
                                          "S3Uri": {
                                                "Get": "Steps.TrainTweetsStep.ModelArtifacts.S3ModelArtifacts"
                                          },
                                          "LocalPath": "/opt/ml/processing/model",
                                          "S3DataType": "S3Prefix",
                                          "S3InputMode": "File",
                                          "S3DataDistributionType": "FullyReplicated",
                                          "S3CompressionType": "None"
                                    }
                              },
                              {
                                    "InputName": "input-2",
                                    "AppManaged": false,
                                    "S3Input": {
                                          "S3Uri": {
                                                "Get": "Steps.PreProcTweetsModelPipe.ProcessingOutputConfig.Outputs['test'].S3Output.S3Uri"
                                          },
                                          "LocalPath": "/opt/ml/processing/test",
                                          "S3DataType": "S3Prefix",
                                          "S3InputMode": "File",
                                          "S3DataDistributionType": "FullyReplicated",
                                          "S3CompressionType": "None"
                                    }
                              },
                              {
                                    "InputName": "code",
                                    "AppManaged": false,
                                    "S3Input": {
                                          "S3Uri": "s3://sagemaker-grewaltempl/artifact-tweets-eval/tweets-pipeline-2022-04-14-19-46-08-170/source/sourcedir.tar.gz",
                                          "LocalPath": "/opt/ml/processing/input/code/",
                                          "S3DataType": "S3Prefix",
                                          "S3InputMode": "File",
                                          "S3DataDistributionType": "FullyReplicated",
                                          "S3CompressionType": "None"
                                    }
                              },
                              {
                                    "InputName": "entrypoint",
                                    "AppManaged": false,
                                    "S3Input": {
                                          "S3Uri": "s3://sagemaker-grewaltempl/artifact-tweets-eval/tweets-pipeline-2022-04-14-19-46-08-170/source/runproc.sh",
                                          "LocalPath": "/opt/ml/processing/input/entrypoint",
                                          "S3DataType": "S3Prefix",
                                          "S3InputMode": "File",
                                          "S3DataDistributionType": "FullyReplicated",
                                          "S3CompressionType": "None"
                                    }
                              }
                        ],
                        "ProcessingOutputConfig": {
                              "Outputs": [
                                    {
                                          "OutputName": "evaluation",
                                          "AppManaged": false,
                                          "S3Output": {
                                                "S3Uri": "s3://sagemaker-grewaltempl/artifact-tweets-eval/tweets-pipeline-2022-04-14-19-46-09-746/output/evaluation",
                                                "LocalPath": "/opt/ml/processing/evaluation",
                                                "S3UploadMode": "EndOfJob"
                                          }
                                    }
                              ]
                        }
                  },
                  "PropertyFiles": [
                        {
                              "PropertyFileName": "TweetsEvaluationReport",
                              "OutputName": "evaluation",
                              "FilePath": "evaluation.json"
                        }
                  ]
            },
            {
                  "Name": "TweetsRegisterAccuracyCond",
                  "Type": "Condition",
                  "Arguments": {
                        "Conditions": [
                              {
                                    "Type": "GreaterThanOrEqualTo",
                                    "LeftValue": {
                                          "Std:JsonGet": {
                                                "PropertyFile": {
                                                      "Get": "Steps.EvaluateTweetsModelPipe.PropertyFiles.TweetsEvaluationReport"
                                                },
                                                "Path": "regression_metrics.mse.value"
                                          }
                                    },
                                    "RightValue": 0.01
                              }
                        ],
                        "IfSteps": [
                              {
                                    "Name": "RegisterTweetsModel",
                                    "Type": "RegisterModel",
                                    "Arguments": {
                                          "ModelPackageGroupName": "TweetsModelPackageGroup-Example1",
                                          "ModelPackageDescription": "Test-Description",
                                          "Tags": [
                                                {
                                                      "Key": "sagemaker:deployment-stage",
                                                      "Value": "prod"
                                                },
                                                {
                                                      "Key": "sagemaker:short-description",
                                                      "Value": "test-describe"
                                                },
                                                {
                                                      "Key": "sagemaker:project-name",
                                                      "Value": "smgithub2"
                                                },
                                                {
                                                      "Key": "sagemaker:stage",
                                                      "Value": "test-stage"
                                                }
                                          ],
                                          "ModelMetrics": {
                                                "ModelQuality": {
                                                      "Statistics": {
                                                            "ContentType": "application/json",
                                                            "S3Uri": "s3://sagemaker-grewaltempl/artifact-tweets-eval/tweets-pipeline-2022-04-14-19-46-09-746/output/evaluation/evaluation.json"
                                                      }
                                                },
                                                "Bias": {},
                                                "Explainability": {}
                                          },
                                          "InferenceSpecification": {
                                                "Containers": [
                                                      {
                                                            "Image": "683313688378.dkr.ecr.us-east-1.amazonaws.com/sagemaker-xgboost:1.3-1",
                                                            "ModelDataUrl": {
                                                                  "Get": "Steps.TrainTweetsStep.ModelArtifacts.S3ModelArtifacts"
                                                            }
                                                      }
                                                ],
                                                "SupportedContentTypes": [
                                                      "text/csv"
                                                ],
                                                "SupportedResponseMIMETypes": [
                                                      "text/csv"
                                                ],
                                                "SupportedRealtimeInferenceInstanceTypes": [
                                                      "ml.t2.medium",
                                                      "ml.m5.large"
                                                ],
                                                "SupportedTransformInstanceTypes": [
                                                      "ml.m5.large"
                                                ]
                                          },
                                          "ModelApprovalStatus": {
                                                "Get": "Parameters.ModelApprovalStatus"
                                          }
                                    },
                                    "Description": "Test-Description"
                              }
                        ],
                        "ElseSteps": []
                  }
            }
      ]
}